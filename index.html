<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFF Loader - RenderWare Model Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 15px;
        }

        #drop-zone {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #drop-zone:hover,
        #drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        #drop-zone p {
            margin-bottom: 10px;
            color: #aaa;
        }

        #file-input {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        #info {
            font-size: 0.85rem;
            color: #888;
        }

        #info strong {
            color: #667eea;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 12px;
            display: none;
            z-index: 200;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #controls-panel {
            max-width: 280px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: #667eea;
        }

        .control-group input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input {
            accent-color: #667eea;
        }

        #stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #888;
        }

        #error-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 300;
            max-width: 400px;
        }

        .sample-models {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sample-models p {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
        }

        .sample-models code {
            font-size: 0.75rem;
            background: rgba(102, 126, 234, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui">
        <div class="panel">
            <h1>DFF Loader</h1>
            <p class="subtitle">RenderWare Model Viewer for Three.js</p>

            <div id="drop-zone">
                <p>Drop .dff or .txd files here</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                    <button class="btn" onclick="document.getElementById('file-input').click()">
                        Load DFF
                    </button>
                    <button class="btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="document.getElementById('txd-input').click()">
                        Load TXD
                    </button>
                </div>
                <input type="file" id="file-input" accept=".dff">
                <input type="file" id="txd-input" accept=".txd" style="display: none;">
            </div>

            <div id="txd-info" style="margin-top: 10px; padding: 8px 12px; background: rgba(245, 87, 108, 0.2); border-radius: 6px; display: none;">
                <p style="font-size: 0.8rem; color: #f5576c;"><strong>TXD:</strong> <span id="txd-name">-</span> (<span id="txd-count">0</span> textures)</p>
            </div>

            <div id="info" style="margin-top: 15px; display: none;">
                <p><strong>File:</strong> <span id="file-name">-</span></p>
                <p><strong>Vertices:</strong> <span id="vertex-count">-</span></p>
                <p><strong>Triangles:</strong> <span id="triangle-count">-</span></p>
                <p><strong>Materials:</strong> <span id="material-count">-</span></p>
            </div>

            <div class="sample-models">
                <p>Load .txd first for textures, then .dff model</p>
                <code>vehicle.txd + vehicle.dff</code>
            </div>
        </div>

        <div class="panel" id="controls-panel">
            <div class="control-group">
                <label>Background Color</label>
                <input type="color" id="bg-color" value="#1a1a2e">
            </div>

            <div class="control-group">
                <label>Rotation Speed: <span id="speed-value">1.0</span></label>
                <input type="range" id="rotation-speed" min="0" max="3" step="0.1" value="1">
            </div>

            <div class="control-group checkbox-group">
                <input type="checkbox" id="auto-rotate" checked>
                <label>Auto Rotate</label>
            </div>

            <div class="control-group checkbox-group">
                <input type="checkbox" id="wireframe">
                <label>Wireframe Mode</label>
            </div>

            <div class="control-group checkbox-group">
                <input type="checkbox" id="show-grid" checked>
                <label>Show Grid</label>
            </div>
        </div>
    </div>

    <div id="stats">
        <span id="fps">0 FPS</span>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading model...</p>
    </div>

    <div id="error-toast"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DFFLoader } from './src/DFFLoader.js';
        import { TXDLoader } from './src/TXDLoader.js';

        // Scene setup
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 3, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(10, 20, 10);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        mainLight.shadow.camera.near = 0.5;
        mainLight.shadow.camera.far = 50;
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0x8888ff, 0.4);
        fillLight.position.set(-10, 5, -10);
        scene.add(fillLight);

        const rimLight = new THREE.DirectionalLight(0xffaa55, 0.3);
        rimLight.position.set(0, -5, -10);
        scene.add(rimLight);

        // Grid
        const grid = new THREE.GridHelper(20, 40, 0x444444, 0x222222);
        scene.add(grid);

        // Current model reference
        let currentModel = null;

        // Loaders
        const dffLoader = new DFFLoader();
        const txdLoader = new TXDLoader();

        // Current texture dictionary
        let currentTextures = null;

        // Load TXD file (returns Promise)
        function loadTXD(file) {
            return new Promise((resolve, reject) => {
                showLoading(true);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        currentTextures = txdLoader.parse(e.target.result);
                        dffLoader.setTextureDictionary(currentTextures);

                        // Update UI
                        document.getElementById('txd-name').textContent = file.name;
                        document.getElementById('txd-count').textContent = currentTextures.size;
                        document.getElementById('txd-info').style.display = 'block';

                        // Log available texture names for debugging
                        console.log(`TXDLoader: Loaded ${currentTextures.size} textures from ${file.name}`);
                        console.log('TXDLoader: Available textures:', Array.from(currentTextures.keys()));

                        showLoading(false);
                        resolve(currentTextures);
                    } catch (error) {
                        console.error('Error loading TXD:', error);
                        showError(`Failed to load textures: ${error.message}`);
                        showLoading(false);
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Load DFF model from file
        function loadModel(file) {
            showLoading(true);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // Remove old model
                    if (currentModel) {
                        scene.remove(currentModel);
                        currentModel.traverse((child) => {
                            if (child.geometry) child.geometry.dispose();
                            if (child.material) {
                                if (Array.isArray(child.material)) {
                                    child.material.forEach(m => m.dispose());
                                } else {
                                    child.material.dispose();
                                }
                            }
                        });
                    }

                    // Parse the model
                    const model = dffLoader.parse(e.target.result);
                    currentModel = model;

                    // Center and scale the model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 4 / maxDim;

                    model.scale.setScalar(scale);
                    model.position.sub(center.multiplyScalar(scale));
                    model.position.y -= (box.min.y * scale);

                    // Enable shadows
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    scene.add(model);

                    // Update info
                    updateInfo(file.name, model);

                    // Reset camera
                    controls.reset();
                    camera.position.set(5, 3, 5);

                    showLoading(false);
                } catch (error) {
                    console.error('Error loading DFF:', error);
                    showError(`Failed to load model: ${error.message}`);
                    showLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Update model info
        function updateInfo(filename, model) {
            let vertices = 0, triangles = 0, materials = 0;

            model.traverse((child) => {
                if (child.isMesh) {
                    const geo = child.geometry;
                    vertices += geo.attributes.position.count;
                    triangles += geo.index ? geo.index.count / 3 : geo.attributes.position.count / 3;
                    materials += Array.isArray(child.material) ? child.material.length : 1;
                }
            });

            document.getElementById('file-name').textContent = filename;
            document.getElementById('vertex-count').textContent = vertices.toLocaleString();
            document.getElementById('triangle-count').textContent = Math.floor(triangles).toLocaleString();
            document.getElementById('material-count').textContent = materials;
            document.getElementById('info').style.display = 'block';
        }

        // UI functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const toast = document.getElementById('error-toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 5000);
        }

        // File input handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const txdInput = document.getElementById('txd-input');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            // Handle multiple files (e.g., both DFF and TXD dropped together)
            const files = Array.from(e.dataTransfer.files);

            // Load TXD files first, then DFF
            const txdFiles = files.filter(f => f.name.toLowerCase().endsWith('.txd'));
            const dffFiles = files.filter(f => f.name.toLowerCase().endsWith('.dff'));

            if (txdFiles.length > 0) {
                // Wait for TXD to fully load before loading DFF
                await loadTXD(txdFiles[0]);
                if (dffFiles.length > 0) {
                    loadModel(dffFiles[0]);
                }
            } else if (dffFiles.length > 0) {
                loadModel(dffFiles[0]);
            } else {
                showError('Please drop .dff or .txd files');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadModel(file);
        });

        txdInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadTXD(file);
        });

        // Controls
        document.getElementById('bg-color').addEventListener('input', (e) => {
            scene.background = new THREE.Color(e.target.value);
        });

        document.getElementById('rotation-speed').addEventListener('input', (e) => {
            controls.autoRotateSpeed = parseFloat(e.target.value);
            document.getElementById('speed-value').textContent = e.target.value;
        });

        document.getElementById('auto-rotate').addEventListener('change', (e) => {
            controls.autoRotate = e.target.checked;
        });

        document.getElementById('wireframe').addEventListener('change', (e) => {
            if (currentModel) {
                currentModel.traverse((child) => {
                    if (child.isMesh && child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(m => m.wireframe = e.target.checked);
                        } else {
                            child.material.wireframe = e.target.checked;
                        }
                    }
                });
            }
        });

        document.getElementById('show-grid').addEventListener('change', (e) => {
            grid.visible = e.target.checked;
        });

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // FPS counter
        let frameCount = 0;
        let lastTime = performance.now();

        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('fps').textContent = `${frameCount} FPS`;
                frameCount = 0;
                lastTime = now;
            }
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            updateFPS();
        }

        animate();

        console.log('%c DFF Loader Ready ', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 5px; font-size: 14px;');
    </script>
</body>
</html>
